ALTER TABLE `tags`
CHANGE `TAG_IGNORE` `TAG_IGNORE` ENUM('N','Y') NOT NULL DEFAULT 'N', 
CHANGE `TAG_DESC_EN_GB` `TAG_DESC_EN_GB` VARCHAR(100) CHARACTER SET utf8 COLLATE utf8_unicode_ci NULL,
CHANGE `TAG_DESC_DE_CH` `TAG_DESC_DE_CH` VARCHAR(100) CHARACTER SET utf8 COLLATE utf8_unicode_ci NULL;

ALTER TABLE `rec_to_tag` ADD PRIMARY KEY( `REC_ID`, `TAG_ID`);

CREATE TABLE IF NOT EXISTS `rec_to_tag_history` (
  `REC_ID` int(11) NOT NULL,
  `TAG_ID` int(11) NOT NULL,
  `CREATED_BY` int(11) NOT NULL,
  `CREATED_ON` int(11) NOT NULL,
  `CHANGED_BY` int(11) NOT NULL,
  `CHANGED_ON` int(11) NOT NULL
) ENGINE=MyISAM DEFAULT CHARSET=utf8 COLLATE=utf8_unicode_ci;

ALTER TABLE `rec_to_tag_history` ADD PRIMARY KEY( `REC_ID`, `TAG_ID`, `CHANGED_ON`);
DELIMITER $$
DROP FUNCTION IF EXISTS `ec`.`getTagId` $$
CREATE FUNCTION `ec`.`getTagId` (newtag VARCHAR(20), lang VARCHAR(5), prf_id INT) RETURNS INT READS SQL DATA
BEGIN
	DECLARE new_id INT;
	IF newtag IS NOT NULL AND newtag <> '' THEN
		IF lang = 'EN_GB' THEN
			SELECT TAG_ID INTO new_id FROM ec.tags WHERE TAG_DESC_EN_GB = newtag;
		ELSE
			IF lang = 'DE_CH' THEN
				SELECT TAG_ID INTO new_id FROM ec.tags WHERE TAG_DESC_DE_CH = newtag;
			ELSEIF lang = 'FR_FR' THEN
				SELECT TAG_ID INTO new_id FROM ec.tags WHERE TAG_DESC_FR_FR = newtag;
			END IF;
			IF new_id IS NULL THEN
				SELECT TAG_ID INTO new_id FROM ec.tags WHERE TAG_DESC_EN_GB = newtag;
			END IF;	
		END IF;
		IF new_id IS NULL THEN
			IF lang = 'EN_GB' THEN
				INSERT INTO ec.tags (TAG_DESC_EN_GB,CREATED_BY,CREATED_ON,CHANGED_BY,CHANGED_ON) VALUES (newtag,prf_id,UNIX_TIMESTAMP(),prf_id,UNIX_TIMESTAMP());
			ELSEIF lang = 'DE_CH' THEN
				INSERT INTO ec.tags (TAG_DESC_DE_CH,CREATED_BY,CREATED_ON,CHANGED_BY,CHANGED_ON) VALUES (newtag,prf_id,UNIX_TIMESTAMP(),prf_id,UNIX_TIMESTAMP());
			ELSEIF lang = 'FR_FR' THEN
				INSERT INTO ec.tags (TAG_DESC_FR_FR,CREATED_BY,CREATED_ON,CHANGED_BY,CHANGED_ON) VALUES (newtag,prf_id,UNIX_TIMESTAMP(),prf_id,UNIX_TIMESTAMP());
			ELSE
				INSERT INTO ec.tags (TAG_DESC_EN_GB,CREATED_BY,CREATED_ON,CHANGED_BY,CHANGED_ON) VALUES (newtag,prf_id,UNIX_TIMESTAMP(),prf_id,UNIX_TIMESTAMP());
			END IF;
			SET new_id = LAST_INSERT_ID();
		END IF;
	END IF;
	return new_id;
END $$
DELIMITER ;
